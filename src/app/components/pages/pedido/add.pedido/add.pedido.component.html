<div class="grid responsiveMediaQuery">
    <div class="col-12">
        <div class="card px-6 p-fluid">
            <h4>{{ id === 0 ? 'Nuevo Pedido' : 'Editar Pedido' }}</h4>
            <form [formGroup]="formPedido" (ngSubmit)="addPedido()">
                <div class="grid p-fluid mt-3">
                    <div class="col-4">
                        <label>Cliente *</label>
                        <p-inputNumber *ngIf="mostrarID" formControlName="cliente"></p-inputNumber>
                        <div>
                            <p-autoComplete formControlName="razonSocial" [suggestions]="sugerenciasClientes"
                                (completeMethod)="buscarClientes($event)" [dropdown]="true"
                                [placeholder]="'Buscar cliente'" (onSelect)="seleccionarCliente($event)"
                                (keyup)="realizarBusquedaEnTiempoReal($event)" (onBlur)="validarClienteExistente()">
                                <ng-template let-cliente pTemplate="item">
                                    {{ cliente.tipoIdentificacion == 'NIT' ?
                                    cliente.razonSocial + ' - ' + cliente.numeroIdentificacion :
                                    cliente.razonSocial + ' ' + cliente.nombreComercial + ' - ' +
                                    cliente.numeroIdentificacion }}
                                </ng-template>
                            </p-autoComplete>
                        </div>
                        <small
                            *ngIf="formPedido.get('razonSocial')?.hasError('required') && formPedido.get('razonSocial')?.touched"
                            style="color: red;">
                            El cliente es <strong>requerido</strong>
                        </small>
                    </div>

                    <div class="col-4">
                        <label htmlFor="contacto">Contacto</label>
                        <div>
                            <input type="text" pInputText [readOnly]="true"
                                [value]="formPedido.get('contacto')!.value" />
                        </div>
                    </div>

                    <div class="col-4">
                        <label htmlFor="ordenTrabajo">Orden de trabajo *</label>
                        <div>
                            <input type="text" (input)="validarOrdenTrabajo()" [maxLength]="8"
                                formControlName="ordenTrabajo" pInputText />
                        </div>
                        <small
                            *ngIf="formPedido.get('ordenTrabajo')?.hasError('required') && formPedido.get('ordenTrabajo')?.touched"
                            style="color: red;">
                            La orden de trabajo es <strong>requerida</strong>
                        </small>
                        <small *ngIf="formPedido.get('ordenTrabajo')?.hasError('soloNumeros')" style="color: red;">
                            Ingrese solo números en la orden de trabajo.
                        </small>
                        <small *ngIf="formPedido.get('ordenTrabajo')?.hasError('ordenTrabajoExistente')"
                            style="color: red;">
                            Esta orden de trabajo ya existe para este cliente.
                        </small>
                    </div>
                </div>

                <div class="grid p-fluid">
                    <div class="col-4">
                        <label htmlFor="fechaOrdenTrabajo">Fecha de orden *</label>
                        <div>
                            <p-calendar formControlName="fechaOrdenTrabajo" [showIcon]="true"
                                inputId="fechaOrdenTrabajo" dateFormat="yy-mm-dd" [maxDate]="maxDate"></p-calendar>
                        </div>
                        <small
                            *ngIf="formPedido.get('fechaOrdenTrabajo')?.hasError('required') && formPedido.get('fechaOrdenTrabajo')?.touched"
                            style="color: red;">
                            La fecha de orden es <strong>requerida</strong>
                        </small>
                    </div>

                    <div class="col-4">
                        <label htmlFor="fechaEntregaOrden">Fecha entrega orden *</label>
                        <div>
                            <p-calendar formControlName="fechaEntregaOrden" [showIcon]="true"
                                inputId="fechaEntregaOrden" dateFormat="yy-mm-dd" [minDate]="minDate"></p-calendar>
                        </div>
                        <small
                            *ngIf="formPedido.get('fechaEntregaOrden')?.hasError('required') && formPedido.get('fechaEntregaOrden')?.touched"
                            style="color: red;">
                            La fecha de entrega es <strong>requerida</strong>
                        </small>
                    </div>
                </div>

                <strong>DETALLES DE REFERENCIA</strong>
                <div class="grid p-fluid mt-1" style="border-top: 1px solid var(--surface-border);">
                    <div class="col-4">
                        <label htmlFor="referencia">Referencia *</label>
                        <div>
                            <input type="text" (input)="validarReferencia()" formControlName="referencia" pInputText />
                        </div>
                        <small
                            *ngIf="formPedido.get('referencia')?.hasError('required') && formPedido.get('referencia')?.touched"
                            style="color: red;">
                            La referencia es <strong>requerida</strong>
                        </small>
                        <small *ngIf="formPedido.get('referencia')?.hasError('soloNumeros')" style="color: red;">
                            Ingrese solo números en la referencia.
                        </small>
                    </div>

                    <div class="col-4">
                        <label htmlFor="descripcion">Descripción *</label>
                        <div>
                            <input type="text" id="descripcion" formControlName="descripcion" pInputText />
                        </div>
                        <small
                            *ngIf="formPedido.get('descripcion')?.hasError('required') && formPedido.get('descripcion')?.touched"
                            style="color: red;">
                            La descripción es <strong>requerida</strong>
                        </small>
                    </div>
                    <div class="col-4">
                        <label htmlFor="valorUnitario">Valor unitario *</label>
                        <div>
                            <p-inputNumber mode="currency" currency="USD" locale="en-US" id="valorUnitario"
                                formControlName="valorUnitario"></p-inputNumber>
                        </div>
                        <small *ngIf=" formPedido.get('valorUnitario')?.touched && formPedido.value.valorUnitario < 1"
                            style="color: red;">
                            El valor debe ser mayor a <strong>0</strong>
                        </small>
                    </div>
                </div>

                <strong>DETALLES DE PROCESOS</strong>
                <div *ngIf="mostrarID != false">
                    <label>id</label>
                    <input type="text" formControlName="idTemporalProceso" />
                    <p-inputNumber formControlName="idProceso"></p-inputNumber>
                </div>

                <div class="grid p-fluid mt-1" style="border-top: 1px solid var(--surface-border);">
                    <div class="col-4">
                        <label htmlFor="proceso">Proceso *</label>
                        <div>
                            <input pInputText type="text" formControlName="proceso" id="proceso" #procesoInput />
                        </div>
                        <small *ngIf="formPedido.get('proceso')?.hasError('required') && formPedido.get('proceso')?.touched 
                            && procesosReferencia.length === 0 " style="color: red;">
                            El procedimientos es <strong>requerido</strong>
                        </small>
                    </div>
                    <div class="col-4">
                        <label htmlFor="tipoMaquina">Tipo de máquina *</label>
                        <div>
                            <select pInputText formControlName="tipoDeMaquina">
                                <option value="" disabled [selected]>Selecciona un tipo de maquina</option>
                                <option *ngFor="let maquina of tipoMaquina" [value]="maquina.value">{{ maquina.label }}
                                </option>
                            </select>
                        </div>
                        <small *ngIf="formPedido.get('tipoDeMaquina')?.hasError('required') && formPedido.get('tipoDeMaquina')?.touched
                            && procesosReferencia.length === 0" style="color: red;">
                            La maquina es <strong>requerida</strong>
                        </small>
                    </div>

                    <p-button
                        *ngIf="formPedido.get('idTemporalProceso')!.value != null || formPedido.get('idProceso')!.value != null"
                        (click)="agregarProceso()" label="Editar proceso" icon="pi pi-plus" severity="warning"
                        styleClass="mt-5">
                    </p-button>
                    <p-button
                        *ngIf="formPedido.get('idTemporalProceso')!.value == null && formPedido.get('idProceso')!.value == null"
                        (click)="agregarProceso()" label="Agregar proceso" icon="pi pi-plus" styleClass="mt-5">
                    </p-button>

                </div>

                <strong>DETALLES DE COLORES</strong>
                <div *ngIf="mostrarID != false">
                    <label>id</label>
                    <input type="text" formControlName="idTemporalColor" />
                    <p-inputNumber formControlName="idColor"></p-inputNumber>
                </div>

                <div class="grid p-fluid mt-1 tallaColor" style="border-top: 1px solid var(--surface-border);">
                    <div class="col-2 color">
                        <label htmlFor="color">Color *</label>
                        <div>
                            <input pInputText type="text" formControlName="color" id="color" #colorInput />
                        </div>
                        <small *ngIf="formPedido.get('color')?.hasError('required') && formPedido.get('color')?.touched 
                            && coloresEnProceso.length === 0" style="color: red;">
                            El color es <strong>requerido</strong>
                        </small>
                    </div>
                    <div class="col-2 ">
                        <label htmlFor="tallaS">S</label>
                        <p-inputNumber formControlName="tallaS"></p-inputNumber>
                    </div>
                    <div class="col-2 ">
                        <label htmlFor="tallaM">M</label>
                        <p-inputNumber formControlName="tallaM"></p-inputNumber>
                    </div>
                    <div class="col-2 ">
                        <label htmlFor="tallaL">L</label>
                        <p-inputNumber formControlName="tallaL"></p-inputNumber>
                    </div>
                    <div class="col-2 ">
                        <label htmlFor="tallaXL">XL</label>
                        <p-inputNumber formControlName="tallaXL"></p-inputNumber>
                    </div>

                    <p-button
                        *ngIf="formPedido.get('idTemporalColor')!.value != null || formPedido.get('idColor')!.value != null"
                        (click)="agregarColor()" label="Editar color" icon="pi pi-plus" severity="warning"
                        styleClass="mt-5">
                    </p-button>
                    <p-button
                        *ngIf="formPedido.get('idTemporalColor')!.value == null && formPedido.get('idColor')!.value == null"
                        (click)="agregarColor()" label="Agregar color" icon="pi pi-plus" styleClass="mt-5">
                    </p-button>

                </div>

                <div class="grid p-fluid">
                    <div class="col-6" *ngIf="procesosReferencia.length > 0">
                        <div class="card " style="overflow-y: 1px;">
                            <p-table styleClass="p-datatable-sm" [value]="procesosReferencia">
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th>Procedimiento</th>
                                        <th>Tipo maquina</th>
                                        <th></th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-proceso let-i="rowIndex">
                                    <tr>
                                        <td>{{proceso.proceso}}</td>
                                        <td>{{proceso.tipoDeMaquina}}</td>
                                        <td>
                                            <p-button icon="pi pi-pencil" [rounded]="true" [text]="true"
                                                (click)="getProcesoModificar(proceso)" pTooltip="Editar"></p-button>
                                            <p-button icon="pi pi-trash" [rounded]="true" [text]="true"
                                                severity="danger " (click)="eliminarProceso(i)"
                                                pTooltip="Eliminar"></p-button>
                                        </td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </div>

                    <div class="col-6" *ngIf="coloresEnProceso.length > 0">
                        <div class="card " style="overflow-y: 1px;">
                            <p-table styleClass="p-datatable-sm" [value]="coloresEnProceso">
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th>Color</th>
                                        <th>S</th>
                                        <th>M</th>
                                        <th>L</th>
                                        <th>XL</th>
                                        <th>Total</th>
                                        <th></th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-color let-i="rowIndex">
                                    <tr>
                                        <td>{{color.color}}</td>
                                        <td>{{color.tallaS}}</td>
                                        <td>{{color.tallaM}}</td>
                                        <td>{{color.tallaL}}</td>
                                        <td>{{color.tallaXL}}</td>
                                        <td>{{color.cantidadTotal}}</td>
                                        <td>
                                            <p-button icon="pi pi-pencil" [rounded]="true" [text]="true"
                                                (click)="getColorModificar(color)" pTooltip="Editar"></p-button>
                                            <p-button icon="pi pi-trash" [rounded]="true" [text]="true"
                                                severity="danger " (click)="eliminarColor(i)"
                                                pTooltip="Eliminar"></p-button>
                                        </td>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="footer">
                                    <tr>
                                        <td>Total</td>
                                        <td>{{ totalTallaS }}</td>
                                        <td>{{ totalTallaM }}</td>
                                        <td>{{ totalTallaL }}</td>
                                        <td>{{ totalTallaXL }}</td>
                                        <td>{{ totalGeneral }}</td>
                                        <td></td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </div>
                </div>

                <div class="grid p-fluid mt-1 justify-content-between">
                    <div class="col-3">
                        <label htmlFor="formaPago"><strong>Formas de pago *</strong></label>
                        <select pInputText formControlName="formaPago">
                            <option value="" disabled [selected]>Seleccione forma de pago</option>
                            <option *ngFor="let forma of formaPago" [value]="forma.value">{{ forma.label }}</option>
                        </select>
                        <small
                            *ngIf="formPedido.get('formaPago')?.hasError('required') && formPedido.get('formaPago')?.touched"
                            style="color: red;">
                            La forma de pago es <strong>requerida</strong>
                        </small>
                    </div>
                    <div class="col-5">
                        <label htmlFor="totalNeto">
                            <h5>Total neto:
                                <p-inputNumber mode="currency" currency="USD" locale="en-US" formControlName="totalNeto"
                                    [readonly]="true"></p-inputNumber>
                            </h5>
                        </label>
                    </div>
                </div>

                <div class="grid p-fluid">
                    <div class="col-12">
                        <div><strong>Observaciones</strong></div>
                        <textarea style="resize: none;" placeholder="Aqui puedes ingresar observaciones adicionales."
                            pInputTextarea></textarea>
                    </div>
                </div>

                <p-confirmDialog></p-confirmDialog>
                <footer class="footer-pedido">
                    <div>
                        <button pButton pRipple type="button" label="Cancelar" class="p-button-danger"
                            (click)="mostrarConfirmacionSalir()"></button>
                        <button pButton pRipple label="Guardar" class="p-button-success"></button>
                    </div>
                </footer>

            </form>
        </div>
    </div>
</div>