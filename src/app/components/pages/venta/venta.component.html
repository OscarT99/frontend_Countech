<div class="grid">
    <div class="col-12">
        <div class="card"> 
            <p-toolbar styleClass="mb-4">
                <ng-template pTemplate="left">                    
                </ng-template>
                <ng-template pTemplate="right">
                    <button pButton class="p-button-success" label="Excel" icon="pi pi-file-excel" pTooltip="Descargar"
                        (click)="exportToExcel()"></button>
                </ng-template>
            </p-toolbar>

            <p-table #dt [value]="listVentas"  responsiveLayout="scroll" [rows]="5" 
                [globalFilterFields]="['cliente','ordenTrabajo','fechaVenta','formaPago','valorTotal','estadoPago']" [paginator]="true" 
                [rowsPerPageOptions]="[5,10,15]" [showCurrentPageReport]="true" 
                currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros" [rowHover]="true" dataKey="id">
                <ng-template pTemplate="caption">
                    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
                        <h5 class="m-0">Lista de Ventas</h5>
                        <span class="block mt-2 md:mt-0 p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" placeholder="Buscar..." (input)="onGlobalFilter(dt, $event)"
                                class="w-full sm:w-auto" />
                        </span>
                    </div>
                </ng-template>
                <ng-template pTemplate="header">
                    <tr>                        
                        <th pSortableColumn="cliente">Cliente<p-sortIcon field="cliente"></p-sortIcon></th>
                        <th pSortableColumn="ordenTrabajo">Orden de Trabajo<p-sortIcon field="ordenTrabajo"></p-sortIcon></th>                        
                        <th pSortableColumn="formaPago">Forma de Pago<p-sortIcon field="formaPago"></p-sortIcon></th>
                        <th pSortableColumn="valorTotal">Valor Total<p-sortIcon field="valorTotal"></p-sortIcon></th>                        
                        <th pSortableColumn="estadoPago">Estado de Pago<p-sortIcon field="estadoPago"></p-sortIcon></th>
                        <th pSortableColumn="acciones">Acciones</th>
                        <th></th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-venta>
                    <tr>                        
                        <td style="width:22%; min-width:5rem;"><span class="p-column-title">Cliente</span>
                            {{ getNombreCliente(venta.cliente) }}
                        </td>
                        <td style="width:14%; min-width:10rem;">
                            <span class="p-column-title">Orden de Trabajo</span>
                            {{ venta.ordenTrabajo }}
                        </td>                        
                        <td style="width:14%; min-width:10rem;">
                            <span class="p-column-title">Forma de Pago</span>
                            {{ venta.formaPago }}
                        </td>  
                        <td style="width:14%; min-width:10rem;">
                            <span class="p-column-title">Valor Total</span>
                            {{ venta.valorTotal | currency:'USD':'symbol':'1.2-2'  }}
                        </td>  
                        <td style="width: 14%; min-width: 10rem;" class="text-center">
                            <span class="p-column-title">Estado</span>
                            <p-tag class="p-element" [severity]="venta.estadoPago === 'Pendiente' ? 'danger' : 'success'">
                                <span class="p-tag-value">{{ venta.estadoPago }}</span>
                            </p-tag>
                        </td>
                        

                        <td>
                            <div class="flex"> 
                                <p-button icon="pi pi-file" [rounded]="true" severity="secondary" class="p-button-rounded p-button-warning mr-2"
                                (click)="mostrarDetallePedido(venta.id)" pTooltip="Ver detalle">
                                </p-button>

                                <button *ngIf="venta.formaPago === 'Crédito' && venta.estadoPago === 'Pendiente'"
                                pButton pRipple icon="pi pi-dollar" class="p-button-rounded p-button-success mr-2" 
                                (click)="newAbonoVenta(venta.id)" pTooltip="Abonar">
                                </button>

                                <button *ngIf="venta.estadoPago === 'Pago'"
                                pButton pRipple icon="pi pi-book" class="p-button-rounded p-button-primary mr-2"
                                (click)="comprobanteVenta1(venta.id)" pTooltip="Comprobante">
                                </button>
                            </div>
                            
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="6" class="text-center">No se encontraron ventas</td>
                    </tr>
                </ng-template>
            </p-table>            

            <p-dialog [(visible)]="productDialogAbono" [style]="{width: '1000px', height: '500px' }" header="Abono Venta" [modal]="true" class="p-fluid">         
                <div style="display: flex;">
                    <div style="flex: 1;">    
                        <form [formGroup]="formVenta" >
                            <div class="formgrid grid">
                                <div class="field col">
                                    <label for="id">Id Venta</label>
                                        <input formControlName="id" id="id" type="number" pInputText readonly >
                                </div>
                                <div class="field col">
                                    <label for="cliente">Cliente</label>
                                        <input id="cliente" type="text" pInputText readonly [value]="getNombreCliente(venta.cliente)">
                                </div>
                                
                            </div>

                            <div class="formgrid grid">

                                <div class="field col">
                                    <label for="valorAbono">Total</label>
                                    <div class="p-inputgroup">
                                        <span class="p-inputgroup-addon">$</span>
                                        <p-inputNumber formControlName="valorTotal" [(ngModel)]="value8" [readonly]="true"></p-inputNumber>
                                    </div>
                                </div>
                                <div class="field col">
                                    <label for="valorAbono">Restante</label>
                                    <div class="p-inputgroup">
                                        <span class="p-inputgroup-addon" readonly>$</span>
                                        <input type="number" formControlName="valorRestante" [readonly]="true" value="{{ getValorRestante() }}">
                                    </div>

                                    
                                </div>
                                                            
                        
                            </div>
                        </form> 
                        <div class="mb-2">
                            <label for="valorAbono">Valor Abono</label>
                        </div>
                        
                        <div class="p-inputgroup">
                            <span class="p-inputgroup-addon">$</span>
                            <p-inputNumber  inputId="valorAbono" [(ngModel)]="value9" placeholder="000.000.000" ></p-inputNumber>
                            <span *ngIf="formAbonoVenta.get('valorAbono')?.hasError('required') && formAbonoVenta.get('valorAbono')?.touched" style="color: red;">
                                El valor del abono es <strong>requerido</strong>
                            </span>
                            <p-toast></p-toast>
                            <button class="ml-1" (click)="confirm2($event)" pButton icon="pi pi-plus" class="p-button-rounded p-button-success"></button>
                            <p-confirmPopup key="confirm2"></p-confirmPopup>
                        </div>
                    </div>
                    <div style="flex: 1;"> 
                        <div class="card m-5" [style]="{width: '500px', textAlign: 'center'}">
                                <h5 >Abonos De La Venta {{ id }}</h5>
                                <p-table #dt [value]="listAbonoVentas" responsiveLayout="scroll" [rows]="10" dataKey="id">
                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th pSortableColumn="idAbono">Id Abono</th>
                                            <th pSortableColumn="fechaAbono">Fecha</th>
                                            <th pSortableColumn="valorAbono">Valor Abonado</th>
                                        </tr>
                                    </ng-template>
                                    <ng-template pTemplate="body" let-abonoVenta>
                                        <tr>
                                            <td style="width:14%; min-width:5rem;"><span class="p-column-title">Id Abono</span>
                                                {{ abonoVenta.id }}
                                            </td>
                                            <td style="width:14%; min-width:10rem;">
                                                <span class="p-column-title">Fecha</span>
                                                {{ abonoVenta.fechaAbono }}
                                            </td>
                                            <td style="width:14%; min-width:8rem;">
                                                <span class= "p-column-title">Valor Abonado</span>
                                                {{ abonoVenta.valorAbono  }}
                                            </td>
                                        </tr>
                                    </ng-template>
                                </p-table>
                        </div>
                        
                        
                        
            
                    
                    </div>
                    
                </div>
            </p-dialog>


            <p-dialog header="Detalle de Venta" [(visible)]="mostrarModalDetalle" [modal]="true" [responsive]="true" [style]="{width: '900px', height: '510spx' }">
                <div *ngIf="detallePedido">
                    <div class="grid mt-1" style="justify-content: center"> 
                        <div class="col-4">
                            <span style="font-weight: bold;">Cliente:</span>
                            <div>
                                <span> {{ detallePedido.Cliente.tipoIdentificacion !== 'NIT' ?
                                    detallePedido.Cliente.razonSocial + ' ' + detallePedido.Cliente.nombreComercial :
                                    detallePedido.Cliente.razonSocial }}</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <span style="font-weight: bold;">Contacto:</span>
                            <div>
                                <span>{{ detallePedido.Cliente.contacto }}</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <span style="font-weight: bold;">Orden de Trabajo:</span>
                            <div>
                                <span>{{ detallePedido.ordenTrabajo }}</span>
                            </div>
                        </div>

                        <div class="col-4">
                            <span style="font-weight: bold;">Fecha Orden:</span>
                            <div>
                                <span>{{ detallePedido.fechaOrdenTrabajo }}</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <span style="font-weight: bold;">Fecha Entrega:</span>
                            <div>
                                <span>{{ detallePedido.fechaEntregaOrden }}</span>
                            </div>
                        </div>

                        <div class="col-4">
                            <span style="font-weight: bold;">Referencia:</span>
                            <div>
                                <span>{{ detallePedido.referencia }}</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <span style="font-weight: bold;">Descripción:</span>
                            <div>
                                <span>{{ detallePedido.descripcion }}</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <span style="font-weight: bold;">Valor Unitario:</span>
                            <div>
                                <span>{{ detallePedido.valorUnitario }}</span>
                            </div>
                        </div>

                        <p-table class="col-6" [value]="detallePedido.ProcesoEnReferenciaEnPedidos">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th>Proceso</th>
                                    <th>Tipo Maquina</th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-proceso>
                                <tr>
                                    <td>{{proceso.proceso}}</td>
                                    <td>{{proceso.tipoDeMaquina}}</td>
                                </tr>
                            </ng-template>
                        </p-table>

                        <p-table class="col-6"
                            [value]="detallePedido.ProcesoEnReferenciaEnPedidos[0]?.ColorEnProcesoEnReferenciaEnPedidos">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th>Color/Talla</th>
                                    <th>S</th>
                                    <th>M</th>
                                    <th>L</th>
                                    <th>XL</th>
                                    <th>Cantidad Total</th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-color>
                                <tr>
                                    <td>{{color.color}}</td>
                                    <td>{{color.tallaS}}</td>
                                    <td>{{color.tallaM}}</td>
                                    <td>{{color.tallaL}}</td>
                                    <td>{{color.tallaXL}}</td>
                                    <td>{{color.cantidadTotal}}</td>
                                </tr>
                            </ng-template>
                        </p-table>

                        <div class="col-4">
                            <span style="font-weight: bold;">Forma Pago:</span>
                            <div>
                                <span>{{ detallePedido.formaPago }}</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <span style="font-weight: bold;">Valor Total:</span>
                            <div>
                                <span>$ {{ detallePedido.valorTotal | number: '1.2-2' }}</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <span style="font-weight: bold;">Estado Pago:</span>
                            <div>
                                <span>{{ detallePedido.estadoPago }}</span>
                            </div>
                        </div>

                    </div>

                   <!--TABLA ABONOS-->
                   <!-- Botón para ver los abonos si la forma de pago es "Crédito" -->
                   <div *ngIf="detallePedido && venta.formaPago === 'Crédito'" style="margin-left: 10px; margin-top: 10px;">
                    <button pButton type="button" [label]="mostrarTablaAbonos ? 'Ocultar Abonos' : 'Ver Abonos'" (click)="mostrarTablaAbonos = !mostrarTablaAbonos"></button>
                    </div>
                
                    <!-- Tabla de abonos si se muestra -->
                    <div *ngIf="mostrarTablaAbonos" style="margin: 0 auto; margin-left: 10px;">
                        <div class="card m-5" [style]="{width: '500px'}">
                            <h5>Abonos De La Venta {{ id }}</h5>
                            <p-table #dt [value]="listAbonoVentas" responsiveLayout="scroll" [rows]="10" dataKey="id">
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th pSortableColumn="idAbono">Id Abono</th>
                                        <th pSortableColumn="fechaAbono">Fecha</th>
                                        <th pSortableColumn="valorAbono">Valor Abonado</th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-abonoVenta>
                                    <tr>
                                        <td style="width:14%; min-width:5rem;"><span class="p-column-title">Id Abono</span>
                                            {{ abonoVenta.id }}
                                        </td>
                                        <td style="width:14%; min-width:10rem;">
                                            <span class="p-column-title">Fecha</span>
                                            {{ abonoVenta.fechaAbono }}
                                        </td>
                                        <td style="width:14%; min-width:8rem;">
                                            <span class="p-column-title">Valor Abonado</span>
                                            {{ abonoVenta.valorAbono }}
                                        </td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </div>

                </div> 
            </p-dialog>



            <p-dialog header="Comprobante de Venta" [(visible)]="mostrarComprobante" [modal]="true" [responsive]="true" [style]="{ width: '600px', height: 'auto' }">
                <div #comprobanteVenta>
                <p-panel header="">
                    <h2>Cuatro Soles</h2>
                    <p>Dirección: Bello Antioquia</p>
                    <p>Teléfono: 210292837</p>
                    <p>Email: cuatrosoles@empresa.com</p>
                  </p-panel>
                  
                  <p-panel header="">
                    <div class="cliente-info">
                      <h3>Cliente</h3>
                      <p><strong>Nombre:</strong> {{ detallePedido?.Cliente?.razonSocial }}</p>
                      <!-- Otras detalles del cliente como dirección, teléfono, etc. -->
                    </div>
                  </p-panel>
                  
                  <p-panel header="">
                    <div class="cliente-info">
                      <h3>Datos de la Venta</h3>
                      <p><strong>Id Venta:</strong> {{ venta.id }}</p>
                      <p><strong>Fecha Venta:</strong> {{ venta.fechaVenta }}</p>
                      <p><strong>Orden de Trabajo:</strong> {{ detallePedido?.ordenTrabajo }}</p>
                      <!-- Otras detalles de la venta como forma de pago, estado de pago, etc. -->
                    </div>
                  
                    <div class="resumen-venta">
                      <h4>______________________________________________________</h4>
                      <p><strong>Forma de Pago:</strong> {{ detallePedido?.formaPago }}</p>
                      <p><strong>Estado de Pago:</strong> {{ detallePedido?.estadoPago }}</p>
                      <p><strong>Valor Total:</strong> {{ detallePedido?.valorTotal | currency }}</p>
                    </div>
                  </p-panel>
                </div>
                  
                <div style="text-align: center; margin-top: 20px; margin-bottom: 20px;">
                    <button pButton class="p-button-danger" label="Descargar" icon="pi pi-file-pdf" pTooltip="Descargar" 
                            (click)="generarPDF()" style="width: 130px; height: 40px; font-size: 20px;"></button>
                </div>
                
                
        
            </p-dialog>
              
            


        </div>
</div>

