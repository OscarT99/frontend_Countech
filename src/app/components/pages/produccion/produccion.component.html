<div class="grid">
<div class="col-12">
<!-- Listar pedidos para producci贸n  -->
<div class="card">
    <p-toolbar styleClass="mb-4">
        <ng-template pTemplate="left">
            <div class="my-2">
              <!-- <button pButton pRipple label="Nuevo empleado" icon="pi pi-plus" class="p-button-success mr-2" (click)="showCreateDialog()"></button>                         -->
              <h5 class="m-0">Pedidos activos en producci贸n</h5>
            </div>
        </ng-template>
        <ng-template pTemplate="right">
            <span class="block mt-2 md:mt-0 p-input-icon-left">
                <i class="pi pi-search"></i>
                <input pInputText type="text" [(ngModel)]="searchText" (input)="filterPedidosByOrdenTrabajo(searchText)" placeholder="Buscar..."  class="w-full sm:w-auto"/>
            </span>        
        </ng-template>
    </p-toolbar>
    <ng-template pTemplate="caption">
        <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
            
            <span class="block mt-2 md:mt-0 p-input-icon-left">
                <i class="pi pi-search"></i>
                <input pInputText type="text" placeholder="Buscar..."  class="w-full sm:w-auto"/>
            </span>
        </div>
    </ng-template>

    <p-accordion [multiple]="false" *ngIf="listSearchPedido.length > 0; else noPedido">
        <p-accordionTab *ngFor="let pedido of listSearchPedido" class="line-height-3 m-2">
            
            <!-- HEADER ACCORDIONTAB -->
            <ng-template pTemplate="header">
                <div class="flex align-items-center">
                    <ng-container *ngFor="let info of listPedidoInfo">
                        <ng-container *ngIf="pedido.id === info.id">
                            <span class="vertical-align-middle">Orden de trabajo: <strong>{{ info.ordenTrabajo }}</strong></span>
                            <!-- PENDIENTE Organizar el icono si ya se asigno una tarea  -->
                            <i *ngIf="info.id !== undefined && info.estado === 'En proceso'" class="pi pi-hourglass ml-2" style="color: rgb(4, 192, 255)"></i>
                            <i *ngIf="info.id !== undefined && info.estado === 'Registrado'" class="pi pi-exclamation-circle ml-2" style="color: rgb(255, 175, 77)"></i>
                            <i *ngIf="info.id !== undefined && info.estado === 'Terminado'" class="pi pi-check-circle ml-2" style="color: rgb(94, 255, 0)"></i>    
                        </ng-container>
                    </ng-container>
                </div>
            </ng-template>

            <!-- INICIO TABLE PEDIDO INFO-->
            <p-table [value]="[pedido]">
                <ng-template pTemplate="caption">
                    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
                        <h5 class="m-0">Detalle del pedido</h5>
                    </div>
                </ng-template>
                <ng-template pTemplate="header">
                    <tr>                                            
                        <th>Cliente</th>
                        <th>Fecha Orden</th>
                        <th>Fecha Entrega</th>
                        <th>Valor Total</th>
                        <th>Estado</th>                                                                
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-pedido>
                    <tr>
                        <td>{{pedido.Cliente.razonSocial}}</td>
                        <td>{{pedido.fechaOrdenTrabajo}}</td>
                        <td>{{pedido.fechaEntregaOrden}}</td>
                        <td>{{pedido.valorTotal}}</td>
                        <ng-container *ngFor="let info of listPedidoInfo">
                            <td *ngIf="pedido.id === info.id">
                                <p-tag [value]="(info.estado)" [severity]="changeSeverityPedido(info.estado ?? '')"></p-tag>
                            </td>                                                               
                        </ng-container>
                    </tr>
                </ng-template>
            </p-table>
            <!-- FINAL TABLE PEDIDO INFO-->

            <!-- INICIO TABVIEW -->
            <p-tabView>
                <ng-container>
                    <!-- INICIO ACOORDION REFERENCIA -->
                    <!-- <p-accordionTab [header]="'Referencia: ' + pedido.referencia"> -->
                        
                            <!-- INICIO TABLE REFERENCIA -->
                            <p-table [value]="[pedido]" styleClass="p-datatable-sm" >
                                <ng-template pTemplate="caption">
                                    Referencia: {{pedido.referencia}}
                                </ng-template>
                                <ng-template pTemplate="header">
                                    <tr>                                            
                                        <th>Descripci贸n</th>
                                        <th>Valor Unit.</th>                                                                
                                        <th>Cant. Total</th>                                                                                                                               
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-pedido>
                                    <tr>
                                        <td>{{pedido.descripcion}}</td>
                                        <td>{{pedido.valorUnitario}}</td>
                                        <td>{{pedido.cantidadTotal}}</td>                                                              
                                    </tr>
                                </ng-template>
                            </p-table>
                            <!-- FINAL TABLE REFERENCIA -->
                        
                        <!-- INICIO TABVIEW PROCESO -->
                        <p-tabView>
                            <ng-container *ngFor="let proceso of listPedidoProceso">
                            <ng-container *ngIf="pedido.id === proceso.pedido">
                                <!-- <ng-container *ngFor=" let i = index"> -->
                                <!-- INICIO TABPANEL PROCESO INFO -->
                                <p-tabPanel>
                                    <ng-template pTemplate="header">
                                        <div class="flex align-items-center">
                                            <span class="vertical-align-middle"><strong>{{ proceso.proceso }}</strong></span>
                                            <!-- PENDIENTE Organizar el icono si ya se asigno una tarea  -->
                                            <i *ngIf="proceso.proceso !== undefined && proceso.cantidadAsignada !== undefined && proceso.estado === false && (proceso.cantidadAsignada > 0)" class="pi pi-hourglass ml-2" style="color: rgb(4, 192, 255)"></i>
                                            <i *ngIf="proceso.cantidadAsignada !== undefined && (proceso.cantidadAsignada === 0)" class="pi pi-exclamation-circle ml-2" style="color: rgb(255, 175, 77)"></i>
                                            <i *ngIf="proceso.proceso !== undefined && proceso.estado === true" class="pi pi-check-circle ml-2" style="color: rgb(94, 255, 0)"></i>
                                        </div>
                                        <!-- <i *ngIf="proceso.id !== undefined && validarRegistroProceso2(proceso.id) && proceso.estado === false" class="pi pi-check ml-2" style="color: green"></i>
                                        <i *ngIf="proceso.estado !== undefined && proceso.estado === true" class="pi pi-circle-fill ml-2" style="color: rgb(255, 255, 0)"></i>
                                        <i *ngIf="proceso.id !== undefined && !validarRegistroProceso2(proceso.id)" class="pi pi-times ml-2" style="color: red"></i>                     -->
                                    </ng-template>

                                    <p-table [value]="[proceso]" selectionMode="single">
                                        <ng-template pTemplate="header">
                                            <tr>                                            
                                                <th>Proceso</th>                                                            
                                                <th>Cant. Total</th>
                                                <th>Cant. Asignada</th>
                                                <th>Cant. Pendiente</th>
                                                <th>Cant. Terminada</th>
                                                <th>Estado</th>
                                                <th></th>                                                                                                                               
                                            </tr>
                                        </ng-template>
                                        <ng-template pTemplate="body" let-proceso>
                                                <tr>                                
                                                  <td>{{proceso.tipoDeMaquina}}</td>
                                                  <td>{{proceso.cantidadTotal}}</td>
                                                  <td>{{proceso.cantidadAsignada || 0}}</td>
                                                  <td>{{proceso.cantidadPendiente || 0}}</td>
                                                  <td>{{proceso.cantidadHecha || 0}}</td>
                                                  
                                                    <ng-container *ngIf="proceso.estado === false && proceso.cantidadAsignada === 0">
                                                        <td>
                                                            <p-tag value="Pendiente" [severity]="changeSeverityProceso('Pendiente')"></p-tag>
                                                        </td>
                                                    </ng-container>
                                                    <ng-container *ngIf="proceso.estado === false && proceso.cantidadAsignada > 0">
                                                        <td>
                                                            <p-tag value="En proceso" [severity]="changeSeverityProceso('En proceso')"></p-tag>
                                                        </td>
                                                    </ng-container>
                                                    <ng-container *ngIf="proceso.estado === true">
                                                        <td>
                                                            <p-tag value="Terminado" [severity]="changeSeverityProceso('Terminado')"></p-tag>
                                                        </td>
                                                    </ng-container>
                                                  
                                 
                                                  <td>
                                                    <div class="flex gap-2 justify-content-center">
                                                      <p-button *ngIf="proceso.estado === false && proceso.cantidadPendiente > 0" icon="pi pi-plus" [rounded]="true" pTooltip="Asignar proceso" (click)="showAsignarProcesoDialog(proceso)"></p-button>
                                                      <p-button icon="pi pi-info" [rounded]="true" pTooltip="Procesos asignados" (click)="showDetalleProcAsigDialog(proceso)"></p-button>
                                                    </div>
                                                  </td>
                                                </tr>
                                          </ng-template>
                                          
                                    </p-table>
                                    <!--  -->
                                    <p-table [value]="proceso.ColorEnProcesoEnReferenciaEnPedidos ?? []" styleClass="p-datatable-striped">
                                        <ng-template pTemplate="header">
                                            <tr>                                            
                                                <th>Color</th>                                                            
                                                <th>Cant. Total</th>  
                                                <th>S</th>
                                                <th>M</th>
                                                <th>L</th>
                                                <th>XL</th>                                                                                            
                                            </tr>
                                        </ng-template>
                                        <ng-template pTemplate="body" let-color>
                                                <tr>
                                                    <td>{{color.color}}</td>
                                                    <td>{{color.cantidadTotal}}</td>
                                                    <td>{{color.tallaS}}</td>
                                                    <td>{{color.tallaM}}</td>
                                                    <td>{{color.tallaL}}</td>
                                                    <td>{{color.tallaXL}}</td>
                                                </tr>
                                        </ng-template>
                                    </p-table>

                                </p-tabPanel>
                            </ng-container>
                        </ng-container>
                        <!-- </ng-container> -->
                                <!-- FINAL TABPANEL PROCESO -->
                        </p-tabView>
                        <!-- FINAL TABVIEW PROCESO -->
                    <!-- </p-accordionTab> -->
                    <!-- FINAL ACCORDION REFERENCIA -->
                </ng-container>
            </p-tabView>
        </p-accordionTab>
    </p-accordion>
    <ng-template #noPedido>
        <div class="text-center">
            <p>No se encontraron pedidos</p>
        </div>
    </ng-template>

    <!-- Dialog para registrar el proceso asignado a un empleado -->
    <p-dialog [(visible)]="asignarProcDialog" [style]="{width: '450px'}" [modal]="true" header="Asignar proceso" class="p-fluid">
        <form [formGroup]="formAsignarProcesoEmpleado" (ngSubmit)="addAsignarProcesoEmpleado()">

                <div class="field">
                    <label for="empleado">Empleado*</label>
                    
                    <div>
                      <p-autoComplete
                        formControlName="empleadoId"
                        [suggestions]="listEmpleados"
                        (completeMethod)="buscarEmpleado($event)"
                        [dropdown]="true"                          
                        [placeholder]="'Seleccionar empleado'"
                        (onSelect)="seleccionarEmpleado($event)">
                        <ng-template let-empleado pTemplate="item">
                                {{empleado.nombre}} {{empleado.apellido}}
                        </ng-template>
                      </p-autoComplete>                              
                    </div>
                    
                    <small *ngIf="formAsignarProcesoEmpleado.get('empleadoId')?.hasError('required') && formAsignarProcesoEmpleado.get('empleadoId')?.touched" style="color: red;">
                        El empleado es <strong>requerido</strong>
                    </small>
                </div>

                <div class="formgrid grid">
                    <div class="field col">
                        <span class="p-float-label">
                            <input type="number" id="cantidadPendiente" [readOnly]="true" [ngStyle]="{'pointer-events': 'none', 'background-color': '#ffffff', 'caret-color': 'transparent'}" pInputText formControlName="cantidadPendiente"/>
                            <label for="cantidadPendiente">Cantidad disponible</label>
                        </span>
                    </div>
                    <div class="field col">
                        <span class="p-float-label">
                            <input id="cantidadAsignada" pKeyFilter="int" type="number" pInputText formControlName="cantidadAsignada" (input)="validateCantAsignada()"/>
                            <label for="cantidadAsignada">Cantidad por asignar*</label>
                        </span>
                        <small>
                            <span *ngIf="formAsignarProcesoEmpleado.get('cantidadAsignada')?.hasError('required') && formAsignarProcesoEmpleado.get('cantidadAsignada')?.touched" style="color: red;">
                                La cantidad es <strong>requerida.</strong>
                            </span>
                            <span *ngIf="formAsignarProcesoEmpleado.get('cantidadAsignada')?.hasError('min') && formAsignarProcesoEmpleado.get('cantidadAsignada')?.touched" style="color: red;">
                                La cantidad asignada debe ser mayor a 0.
                            </span>
                            <span *ngIf="formAsignarProcesoEmpleado.get('cantidadAsignada')?.hasError('cantError') && formAsignarProcesoEmpleado.get('cantidadAsignada')?.touched" style="color: red;">
                                La cantidad asignada no puede ser mayor a la cantidad disponible.
                            </span>
                        </small>
                    </div>
                </div>
                <div class="formgrid col grid mt-2 justify-content-end">
                    <p-button label="Cancelar" icon="pi pi-times" [text]="true" (click)="hideDialog()"></p-button>
                    <p-button type="submit" label="Asignar" icon="pi pi-check"></p-button>
                </div>
                  
        </form>
    </p-dialog>


    <!-- Dialog para ver los procesos asignados y registrar avances -->

    <p-dialog [(visible)]="detalleProcAsigDialog" header="Procesos asignados" [style]="{width:'80vw'}" [draggable]="false" [resizable]="false" [modal]="true" class="p-fluid">
        <!-- <div class="card"> -->
            <p-table [value]="filteredProcesosAsignados" dataKey="id">
                <!-- <ng-template pTemplate="caption">
                    Procesos asignados
                </ng-template> -->
                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 5rem"></th>
                        <!-- <th>Code</th> -->
                        <th>Empleado</th>
                        <th>Cantidad asignada</th>
                        <th>Cantidad restante</th>
                        <th>Cantidad hecha</th>
                        <th>Estado producci贸n</th>
                        <th>Estado proceso</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-proceso let-expanded="expanded">
                    <tr>
                        <td>
                            <ng-container *ngIf="proceso.estadoAnular === false">
                                <button type="button" pButton pRipple [pRowToggler]="proceso" class="p-button-text p-button-rounded p-button-plain" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                            </ng-container>
                        </td>
                        <!-- <td>{{proceso.id}}</td> -->
                        <td>{{proceso.nombreEmpleado}}</td>
                        <td>{{proceso.cantidadAsignada}}</td>
                        <td>{{proceso.cantRestante}}</td>
                        <ng-container *ngIf="proceso.estadoProcAsig === true && proceso.estadoAnular === false">
                            <td>
                                {{proceso.cantidadAsignada}}
                            </td>
                        </ng-container>
                        <ng-container *ngIf="proceso.estadoProcAsig === true && proceso.estadoAnular === true">
                            <td>
                                0
                            </td>
                        </ng-container>
                        <ng-container *ngIf="proceso.estadoProcAsig === false">
                            
                            <td *ngIf="proceso.estadoProcAsig === false">
                                <form [formGroup]="formAvance" (ngSubmit)="crearAvance(proceso.id)">
                                    <div class="formgrid col grid mt-2 justify-content-end" style="display: flex; flex-direction: row; padding: 0;">
                                        <div style="flex: 1;">
                                            <span class="p-float-label">
                                                <input type="number" pInputText formControlName="cantidadHecha" (input)="validateCantHecha(proceso.cantRestante)"/>
                                                <label for="cantidadHecha">Cantidad hecha*</label>
                                            </span>
                                            <small>
                                                <span *ngIf="formAvance.get('cantidadHecha')?.hasError('required') && formAvance.get('cantidadHecha')?.touched" style="color: red;">
                                                    La cantidad es <strong>requerida.</strong>
                                                </span>
                                                <span *ngIf="formAvance.get('cantidadHecha')?.hasError('min') && formAvance.get('cantidadHecha')?.touched" style="color: red;">
                                                    La cantidad debe ser mayor a 0.
                                                </span>
                                                <span *ngIf="formAvance.get('cantidadHecha')?.hasError('cantError') && formAvance.get('cantidadHecha')?.touched" style="color: red;">
                                                    La cantidad no debe ser mayor a la <strong>cantidad restante</strong>.
                                                </span>
                                            </small>
                                        </div>
                                        <div style="margin-left: 8px;">
                                            <p-button type="submit" icon="pi pi-save" [rounded]="true" [text]="true" severity="success" pTooltip="Guardar"></p-button>        
                                        </div>
                                    </div>
                                </form>
                            </td>

                        </ng-container>
                        <td>
                            <p-tag [value]="changeEstadoProd(proceso.estadoProcAsig, proceso.estadoAnular)" [severity]="getEstadoProd(proceso.estadoProcAsig, proceso.estadoAnular)"></p-tag>
                        </td>
                            <td *ngIf="proceso.estadoAnular === true">
                                <p-tag [value]="changeEstadoAnular(proceso.estadoAnular)" [severity]="styleEstadoAnular(proceso.estadoAnular)"></p-tag>
                            </td>
                        
                            <td class="padding: 0;" *ngIf="proceso.estadoAnular === false && proceso.estadoProcAsig === false && proceso.cantidadAsignada === proceso.cantRestante">
                                <p-button (click)="confirm(proceso.id)" icon="pi pi-times-circle" [rounded]="true" severity="danger" pTooltip="Anular"></p-button>
                            </td>
                            <td *ngIf="proceso.estadoProcAsig === true && proceso.estadoAnular === false || proceso.estadoProcAsig === false && proceso.estadoAnular === false && proceso.cantidadAsignada !== proceso.cantRestante">

                            </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="rowexpansion" let-proceso>
                        <td colspan="8">
                            <div class="p-3">
                                <p-table [value]="proceso.avanceProcesoEmpleados" dataKey="id">
                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th>Cantidad hecha</th>
                                            <th>Fecha</th>
                                            <th>Hora</th>
                                        </tr>
                                    </ng-template>
                                    <ng-template pTemplate="body" let-avance>
                                        <tr>
                                          <td>{{ avance.cantidadHecha }}</td>
                                          <td>{{ avance.date }}</td>
                                          <td>{{ avance.time }}</td>
                                        </tr>                                        
                                    </ng-template>
                                    <ng-template pTemplate="emptymessage">
                                        <tr>
                                            <td colspan="3" class="text-center">No tiene registro de avances</td>
                                        </tr>
                                    </ng-template>
                                </p-table>
                            </div>
                        </td>
                </ng-template>
            </p-table>
            <p-confirmDialog></p-confirmDialog>

            <div class="formgrid col grid mt-2 justify-content-end">
                <p-button label="Cerrar" icon="pi pi-times" [text]="true" (click)="hideDialog()"></p-button>
            </div>


    </p-dialog>

</div>

</div>
</div>

